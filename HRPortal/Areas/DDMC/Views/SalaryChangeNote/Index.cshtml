@model IEnumerable<HRPortal.Mvc.Models.SalaryChangeNoteViewModel>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    th {
        padding-left: 5px;
    }
</style>
@using (Html.BeginForm("Index", "SalaryChangeNote", FormMethod.Post, new { id = "SalaryChangeNoteForm" }))
{
    if (TempData["message"] != null)
    {
        <script type="text/javascript">
            $(function () {
                var message = @Html.Raw(Json.Encode(TempData["message"]));
                showAlertMessage(message);
            });
        </script>
    }
    if (ViewBag.Status == null || ViewBag.Status == "false" || Session["_OutTime"] == null || DateTime.Parse(Session["_OutTime"].ToString()) < DateTime.Now)
    {
        <div class="col-xs-12">
            <h4 class="text-danger">※請再次輸入您的登入密碼，才可使用該功能。</h4>
            <!--<label for="Password" style="font-weight: bold;color: red;">提醒您：密碼連續輸入錯誤3次，將被鎖定並立即登出，請逕洽HR。</label>-->
        </div>
        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-md-2 control-label" style="font-size:16px;width:7.6%">密碼：</label>
                <div class="col-md-4">
                    <input type="password" name="PWdata" class="form-control" id="PWdata" />
                </div>
                <button name="btnCheckPW" id="btnCheckPW" class="col-md-2 btn btn-success" type="button">@HRPortal.MultiLanguage.Resource.BtnSubmit</button>
            </div>
        </div>
    }
    else
    {
        
    <div class=" row">
    <div class="search-container" style="margin-right: 13px; border-left-width: 5px; margin-left: 13px;">

 
        </div>
            </div>
   <input type="hidden" id="searchkey" name="searchkey" value="" />
    <div class="col-xs-12">
        @if (Model != null)
        {
            <input type="hidden" id="ExcutionDate" name="ExcutionDate" value="" />
            <input type="hidden" id="Illustate" name="Illustate" value="" />
            <div class="table-responsive">
                <table tabindex="0" cellspacing="0" cellpadding="0" border="0" class="table-bordered ui-jqgrid ui-widget ui-widget-content ui-corner-all" style="height:50px;width:100%">
                    <tr class="ui-jqgrid-labels" role="rowheader" style="height:40px;color:#777">
                        <div style="color:#F00">※下載後，PDF開啟密碼預設為身分證字號後6碼+生日月份4碼(ex:3月7日及輸入0307)</div>
                        @*<div style="color:#F00">※薪資資料從2018年3月起全面提供</div>*@  
                        <th class="" style="width:20%">
                            <div id="jqgh_grid-table_code" class="" style="text-align:center;">異動年月</div>
                        </th>
                        <th class="" style="width:20%">
                             <div id="jqgh_grid-table_code" class="" style="text-align:center;">異動原因</div>
                        </th>
                        <th class="" style="width:1%">

                        </th>

                    </tr>
                    @if (Model.Count() > 0)
                    {
                        foreach (var item in Model)
                        {
                            <tr role="row" tabindex="-1" id="@item.ExcutionDate" class="ui-widget-content jqgrow ui-row-ltr">
                                <td role="gridcell" class="" style="white-space:normal" aria-describedby="grid-table_notification_count">
                                    @item.ExcutionDate
                                </td>
                                <td role="gridcell" class="" style="white-space:normal" aria-describedby="grid-table_notification_count">
                                    @item.Illustate
                                </td>

                                <td role="gridcell" style="white-space:normal;text-align:center" aria-describedby="grid-table_notification_count">
                                    <a class="btn btn-success" onclick="exportPDF('@item.Illustate','@item.ExcutionDate');">@HRPortal.MultiLanguage.Resource.BtnDownload</a>
                                </td>

                            </tr>
                        }
                    }
                    else
                    {
                        <tr role="row" tabindex="-1" class="ui-widget-content jqgrow ui-row-ltr">
                            <td colspan="6" style="text-align:center">
                                @HRPortal.MultiLanguage.Resource.NoData
                            </td>
                        </tr>
                    }
                </table>
            </div>
            <div style="text-align:center">
                @* 在後面對pagelist做轉型 *@
                @using PagedList
                @using PagedList.Mvc
                @{
                    var data = Model as IPagedList<HRPortal.Mvc.Models.SalaryChangeNoteViewModel>
                        ;
                }
                @{
                    if (IsAjax)
                    { Layout = ""; }
                }
                @if (Model.Count() > 0)
                {


                    @Html.PagedListPager(data, page => Url.Action("Index",
                                                      new { page, BeginDate = ViewBag.StartTime, EndDate = ViewBag.EndTime }), PagedListRenderOptions.ClassicPlusFirstAndLast)

                    @Html.PagedListPager(data, page => Url.Action("Index",
                                                  new { page, BeginDate = ViewBag.StartTime, EndDate = ViewBag.EndTime }), new PagedListRenderOptions
                                                  {
                                                      DisplayLinkToFirstPage = PagedListDisplayMode.Never,
                                                      DisplayLinkToLastPage = PagedListDisplayMode.Never,
                                                      DisplayLinkToPreviousPage = PagedListDisplayMode.Never,
                                                      DisplayLinkToNextPage = PagedListDisplayMode.Never,
                                                      DisplayLinkToIndividualPages = false,
                                                      //LinkToFirstPageFormat = "<<第一頁",
                                                      //LinkToPreviousPageFormat = "<前一頁",
                                                      //LinkToNextPageFormat = "後一頁>",
                                                      //LinkToLastPageFormat = "最末頁>>",
                                                      DisplayPageCountAndCurrentLocation = true,
                                                      PageCountAndCurrentLocationFormat = @HRPortal.MultiLanguage.Resource.Pageof,
                                                      DisplayItemSliceAndTotal = true,
                                                      ItemSliceAndTotalFormat = @HRPortal.MultiLanguage.Resource.ofrow
                                                  })
                }
            </div>
        }
    </div>

 <script type="text/javascript">
     //指定多少毫秒無動作轉跳
     var timeout = @(string.IsNullOrWhiteSpace(ViewBag.DeptSumQueryTimeout) ? 6000 : int.Parse(ViewBag.DeptSumQueryTimeout));

     //紀錄當前時間
     var occurtime=new Date().getTime() ;

     //判斷無動作的時間轉跳
     function goUrl(){
         var a = parseInt(new Date().getTime() - occurtime);
         if(a>=timeout){
                          @{
                              Session["_OutTime"] = null;
                          }
             window.location.href = '@Url.Action("Index", "Home", new { area = "" })';
             intservalID=window.clearInterval(intservalID);
         }
     }
     //隔1000毫秒判斷一次
     var intservalID=window.setInterval("goUrl()",1000);


     function resettime()
     {
         occurtime = new Date().getTime();
         @{
             Session["_OutTime"] = DateTime.Now.AddMinutes(1);
         }
     }

            </script>
}
}

<script>
    $(function () {
        $.ajaxSetup({ cache: false });

        $('#btnQuery').click(function (event) {
            var form = $('#SalaryChangeNoteForm');

            //if ($('#EndDate').val() != "" && $('#BeginDate').val() == "")
            //    showAlertMessage("請輸入查詢起始日期");
            //else {
            $('#searchkey').val(1);
            form.submit();
            //}

        });

    });

    function exportPDF(illustateData, excutionDate) {
        $('#Illustate').val(illustateData);
        $('#ExcutionDate').val(excutionDate);
        var form = $('#SalaryChangeNoteForm');
        form.submit();

    }
    $(function () {

        //停用按下Return鍵會自動送出表單的動作
        $(document).on('keypress', 'form input[type="password"]', function(e) {
            if(e.which == 13) {
                e.preventDefault();
                //$('#btnCheckPW').trigger('click');
                return false;
            }
        });

        $('#btnCheckPW').click(function (event) {
            var form = $('#SalaryChangeNoteForm');

            if ($('#PWdata').val() == "")
                showAlertMessage("請輸入密碼");
            else {
                checkPassword();
            }

        });

        function checkPassword() {
            var form = $('#SalaryChangeNoteForm');
            var submitData = new FormData(form[0]);
            $.ajax({
                url: 'SalaryChangeNote/CheckPassword',
                type: 'POST',
                data: submitData,
                contentType: false,
                processData: false,
                success: function (checkResult) {
                    if (checkResult.status != 'success') {
                        $('#PWdata').val('');
                        showAlertMessage(checkResult.message, function(){
                            window.location='@Url.Action("Index")';    
                        });
                    }
                    else {
                        form.submit();
                    }
                }
            });

        }
    });
</script>
