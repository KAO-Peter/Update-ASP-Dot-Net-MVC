@model HRPortal.Mvc.DDMC_PFA.Models.PfaCycleRationCreateViewModel

@Scripts.Render("~/bundles/validate")

@{
    ViewBag.Title = "CreatePfaCycleRation";
}
<style>
    .form-horizontal .form-group {
        margin-right: -15px;
        margin-left: 5px;
    }
</style>
<div class="modal-dialog" style="width:1200px">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">評等人數配比設定</h4>
        </div>
        @using (Html.BeginForm("Create", "PfaCycleRation", FormMethod.Post, new { @id = "CreatePfaCycleRationForm", @class = "form-horizontal", role = "form" }))
        {
            <div class="modal-body" style="height:500px; overflow-y:scroll">
                <div class="tab-content">
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">考核批號</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.DropDownList("PfaCycleID", Model.CycleList, new { @id = "PfaCycleID", @class = "form-control" })<br />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">部門組織</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.DropDownList("PfaOrgID", Model.OrgList, new { @id = "PfaOrgID", @class = "form-control" })<br />
                        </div>
                        <div class="col-sm-1">
                            <button type="button" id="btnQueryDetail" class="btn btn-primary">查詢</button>
                        </div>
                        <div style="margin: 10px 0px 0px 15px">
                            <span id="DeptName">@Model.DeptName</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">總人數</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.TextBoxFor(model => model.OrgTotal, new { @class = "form-control", @disabled = true })<br />
                        </div>
                    </div>
                </div>
                <div class="tab-content">
                    <div class="table-responsive">
                        <table id="tableData" cellspacing="0" cellpadding="0" border="0" class="table table-bordered ui-jqgrid">
                            <thead>
                                <tr class="ui-jqgrid-labels" role="rowheader" style="height:40px;color:#777">
                                    <th style="width: 15%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">Performance</div>
                                    </th>
                                    <th style="width: 7%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">佔比(%)</div>
                                    </th>
                                    <th style="width: 8%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">band</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">Multiplier</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">總人數</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">計算人數</div>
                                    </th>
                                    <th style="width: 30%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">分配人數</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">核對試算</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tbodyData">
                            </tbody>
                            <tbody id="tbodyEnd">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnSave" class="btn btn-success"> @HRPortal.MultiLanguage.DDMC_PFA.Resource.BtnSave</button>
                <button type="button" class="btn btn-default" data-dismiss="modal"> @HRPortal.MultiLanguage.DDMC_PFA.Resource.BtnClose</button>
            </div>
        }
    </div>
</div>

<script type="text/javascript">
    $(function () {
        //績效考核批號
        $("#PfaCycleID").change(function () {
            $("#OrgTotal").val("");
            $("#DeptName").text("");
            $("#tbodyData").empty();
            $("#tbodyEnd").empty();

            var jsonObj = { "PfaCycleID": $("#PfaCycleID").val() };
            $.ajax({
                url: "PfaCycleRation/QueryOrgList",
                type: "POST",
                data: jsonObj,
                async: true,
                dataType: "json",
                success: function (result) {
                    if (!result.success) {
                        showAlertMessage(result.message);
                    } else {
                        var empSelect = $("#PfaOrgID");
                        $(empSelect).empty();
                        $.each(result.data, function (index, data) {
                            empSelect.append($("<option></option>").val(data.Value).html(data.Text));
                        });
                    }
                }
            });
        });

        $("#PfaOrgID").change(function () {
            $("#OrgTotal").val("");
            $("#DeptName").text("");
            $("#tbodyData").empty();
            $("#tbodyEnd").empty();
        });

        $('#btnQueryDetail').click(function () {
            if ($("#PfaCycleID").val() == "") {
                showAlertMessage("請選擇考核批號");
                return false;
            }
            if ($('#PfaOrgID').val() == "") {
                showAlertMessage("請選擇部門組織");
                return false;
            }

            var jsonObj = { "PfaCycleID": $("#PfaCycleID").val(), "PfaOrgID": $('#PfaOrgID').val() };
            $.ajax({
                url: "PfaCycleRation/QueryDetail",
                type: "POST",
                data: jsonObj,
                async: true,
                dataType: "json",
                success: function (result) {
                    if (result.success) {
                        $("#OrgTotal").val(result.detail.OrgTotal);
                        $("#DeptName").text(result.detail.DeptName);
                        $("#tbodyData").empty().append(result.data);
                        $("#tbodyEnd").empty().append(result.dataEnd);
                    }
                }
            });
        });

        $("#tableData").delegate("button[id='btnCal']", "click", function () {
            var OrgTotal = parseInt($("#OrgTotal").val());
            var StaffingTotal = 0;

            var nidx = 0;
            $("#tbodyData tr").each(function () {
                StaffingTotal += parseInt($($(this).find("input[id='Staffing']")[0]).val());

                nidx += 1;
            });

            if (OrgTotal != StaffingTotal) {
                var n = 0;
                if (OrgTotal > StaffingTotal)
                {
                    n = OrgTotal - StaffingTotal;
                    showAlertMessage("分配人數要完整才能試算!，尚有" + n + "人未分配");
                } else
                {
                    n = StaffingTotal - OrgTotal;
                    showAlertMessage("分配人數要完整才能試算!，分配人數超過" + n + "人");
                }
                $("#tbodyData tr").each(function () {
                    $($(this).find("td[id='CalStaffing']")[0]).text("");
                });
                $("#tbodyEnd tr").each(function () {
                    $($(this).find("td[id='ScoreTotal']")[0]).text("");
                });
                return false;
            }

            nidx = 0;
            var item = [];
            $("#tbodyData tr").each(function () {
                item[nidx] = new Object();
                item[nidx].PfaPerformanceID = $($(this).find("input[id='PfaPerformanceID']")[0]).val();
                item[nidx].Staffing = $($(this).find("input[id='Staffing']")[0]).val();
                nidx += 1;
            });

            var obj = new Object();
            obj.OrgTotal = $('#OrgTotal').val();
            obj.Data = item;
            var jsonObj = { "obj": obj };
            $.ajax({
                url: "PfaCycleRation/Calculation",
                type: "POST",
                data: jsonObj,
                async: true,
                dataType: "json",
                success: function (result) {
                    if (result.success) {
                        $("#tbodyData").empty().append(result.data);
                        $("#tbodyEnd").empty().append(result.dataEnd);
                    }
                }
            });
        });

        $('#btnSave').click(function () {
            var obj = new Object();
            obj.PfaCycleID = $("#PfaCycleID").val();
            obj.PfaOrgID = $('#PfaOrgID').val();
            obj.OrgTotal = $('#OrgTotal').val();
            obj.Action = "Create";

            if (obj.PfaCycleID == "")
            {
                showAlertMessage("請選擇考核批號");
                return false;
            }
            if (obj.PfaOrgID == "") {
                showAlertMessage("請選擇部門組織");
                return false;
            }

            var nidx = 0;
            var item = [];
            var error = false;
            $("#tbodyData tr").each(function () {
                item[nidx] = new Object();
                item[nidx].PfaPerformanceID = $($(this).find("input[id='PfaPerformanceID']")[0]).val();
                item[nidx].Staffing = $($(this).find("input[id='Staffing']")[0]).val();

                if (isNaN(item[nidx].Staffing)) {
                    showAlertMessage("分配人數僅能輸入數字");
                    $($(this).find("input[id='Staffing']")[0]).select();
                    error = true;
                    return false;
                }
                nidx += 1;
            });

            if (error == false)
            {
                obj.Data = item;
                var jsonObj = { "obj": obj };
                $.ajax({
                    url: "PfaCycleRation/Create",
                    type: "POST",
                    data: jsonObj,
                    async: true,
                    dataType: "json",
                    success: function (result) {
                        var message = result.message;
                        showAlertMsg(message, function () {
                            if (result.success) {
                                $('#PfaCycleRationDetailDialogDiv').modal('hide');
                                location.reload();
                            }
                        });
                    }
                });
            }
        });
    });
</script>