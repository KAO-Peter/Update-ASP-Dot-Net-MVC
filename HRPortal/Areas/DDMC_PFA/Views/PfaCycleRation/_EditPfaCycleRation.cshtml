@model HRPortal.Mvc.DDMC_PFA.Models.PfaCycleRationCreateViewModel

@Scripts.Render("~/bundles/validate")

@{
    ViewBag.Title = "EditPfaCycleRation";
}
<style>
    .form-horizontal .form-group {
        margin-right: -15px;
        margin-left: 5px;
    }
</style>
<div class="modal-dialog" style="width:1200px">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">評等人數配比設定</h4>
        </div>
        @using (Html.BeginForm("Edit", "PfaCycleRation", FormMethod.Post, new { @id = "EditPfaCycleRationForm", @class = "form-horizontal", role = "form" }))
        {
            @Html.ValidationSummary(true)
            @Html.AntiForgeryToken()
            @Html.HiddenFor(x => x.ID)
            <div class="modal-body" style="height:500px; overflow-y:scroll">
                <div class="tab-content">
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">考核批號</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.DropDownList("PfaCycleID", Model.CycleList, new { @id = "PfaCycleID", @class = "form-control", @disabled = true })<br />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">部門組織</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.DropDownList("PfaOrgID", Model.OrgList, new { @id = "PfaOrgID", @class = "form-control", @disabled = true })<br />
                        </div>
                        <div style="margin: 10px 0px 0px 15px">
                            <span>@Model.DeptName</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-22" style="width: 10%;">總人數</label>
                        <div class="col-sm-44" style="width:23%">
                            @Html.TextBoxFor(model => model.OrgTotal, new { @class = "form-control", @disabled = true })<br />
                        </div>
                    </div>
                </div>
                <div class="tab-content">
                    <div class="table-responsive">
                        <table id="tableData" cellspacing="0" cellpadding="0" border="0" class="table table-bordered ui-jqgrid">
                            <thead>
                                <tr class="ui-jqgrid-labels" role="rowheader" style="height:40px;color:#777">
                                    <th style="width: 15%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">Performance</div>
                                    </th>
                                    <th style="width: 7%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">佔比(%)</div>
                                    </th>
                                    <th style="width: 8%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">band</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">Multiplier</div>
                                    </th>
                                    <th style="width: 10%; display: none">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">總人數</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">計算人數</div>
                                    </th>
                                    <th style="width: 30%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">分配人數</div>
                                    </th>
                                    <th style="width: 10%">
                                        <div class="ui-jqgrid-sortable" style="text-align:center;">核對試算</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tbodyData">
                                @if (Model.Data != null)
                                {
                                    foreach (var item in Model.Data)
                                    {
                                        <tr role="row" tabindex="-1" class="ui-widget-content jqgrow ui-row-ltr">
                                            @Html.Hidden("CycleRationDetailID", item.ID)
                                            @Html.Hidden("PfaCycleRationID", item.PfaCycleRationID)
                                            @Html.Hidden("PfaPerformanceID", item.PfaPerformanceID)
                                            <td style="white-space:normal; text-align:center">
                                                @item.Performance
                                            </td>
                                            <td style="white-space: normal; text-align: center">
                                                @item.Rates
                                            </td>
                                            <td style="white-space: normal; text-align: center">
                                                @item.band
                                            </td>
                                            <td style="white-space: normal; text-align: center">
                                                @item.Multiplier
                                            </td>
                                            <td style="white-space: normal; text-align: center; display: none ">
                                                @item.Total
                                            </td>
                                            <td style="white-space: normal; text-align: center">
                                                @item.BudgetTotal
                                            </td>
                                            <td style="white-space:normal">
                                                @Html.TextBox("Staffing", item.Staffing, new { @class = "form-control" })
                                            </td>
                                            <td style="white-space: normal; text-align: center">
                                                @item.TotalScore
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tbody id="tbodyEnd">
                                <tr role="row" tabindex="-1" class="ui-widget-content jqgrow ui-row-ltr">
                                    <td style="white-space:normal;text-align:right;" colspan="5">合計</td>
                                    <td style="white-space:normal;text-align:center;">
                                        @Model.StaffingTotal
                                        <button type="button" id="btnCal" class="btn btn-primary">試算</button>
                                    </td>
                                    <td style="white-space:normal;text-align:center;">
                                        @Model.ScoreTotal
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnSave" class="btn btn-success"> @HRPortal.MultiLanguage.DDMC_PFA.Resource.BtnSave</button>
                <button type="button" class="btn btn-default" data-dismiss="modal"> @HRPortal.MultiLanguage.DDMC_PFA.Resource.BtnClose</button>
            </div>
        }
    </div>
</div>

<script type="text/javascript">

    $(function () {
        $("#tableData").delegate("button[id='btnCal']", "click", function () {
            var OrgTotal = parseInt($("#OrgTotal").val());
            var StaffingTotal = 0;

            var nidx = 0;
            $("#tbodyData tr").each(function () {
                StaffingTotal += parseInt($($(this).find("input[id='Staffing']")[0]).val());

                nidx += 1;
            });

            if (OrgTotal != StaffingTotal) {
                var n = 0;
                if (OrgTotal > StaffingTotal) {
                    n = OrgTotal - StaffingTotal;
                    showAlertMessage("分配人數要完整才能試算!，尚有" + n + "人未分配");
                } else {
                    n = StaffingTotal - OrgTotal;
                    showAlertMessage("分配人數要完整才能試算!，分配人數超過" + n + "人");
                }
                return false;
            }

            nidx = 0;
            var item = [];
            $("#tbodyData tr").each(function () {
                item[nidx] = new Object();
                item[nidx].ID = $($(this).find("input[id='CycleRationDetailID']")[0]).val();
                item[nidx].PfaCycleRationID = $($(this).find("input[id='PfaCycleRationID']")[0]).val();
                item[nidx].PfaPerformanceID = $($(this).find("input[id='PfaPerformanceID']")[0]).val();
                item[nidx].Staffing = $($(this).find("input[id='Staffing']")[0]).val();

                nidx += 1;
            });

            var obj = new Object();
            obj.ID = $("#ID").val();
            obj.OrgTotal = $('#OrgTotal').val();
            obj.Action = "Edit";
            obj.Data = item;
            var jsonObj = { "obj": obj };
            $.ajax({
                url: "PfaCycleRation/Calculation",
                type: "POST",
                data: jsonObj,
                async: true,
                dataType: "json",
                success: function (result) {
                    if (result.success) {
                        $("#tbodyData").empty().append(result.data);
                        $("#tbodyEnd").empty().append(result.dataEnd);
                    }
                }
            });
        });

        $('#btnSave').click(function () {
            var obj = new Object();
            obj.ID = $("#ID").val();
            obj.PfaCycleID = $("#PfaCycleID").val();
            obj.PfaOrgID = $('#PfaOrgID').val();
            obj.OrgTotal = $('#OrgTotal').val();

            var nidx = 0;
            var item = [];
            var error = false;
            $("#tbodyData tr").each(function () {
                item[nidx] = new Object();
                item[nidx].ID = $($(this).find("input[id='CycleRationDetailID']")[0]).val();
                item[nidx].PfaCycleRationID = $($(this).find("input[id='PfaCycleRationID']")[0]).val();
                item[nidx].PfaPerformanceID = $($(this).find("input[id='PfaPerformanceID']")[0]).val();
                item[nidx].Staffing = $($(this).find("input[id='Staffing']")[0]).val();

                if (isNaN(item[nidx].Staffing)) {
                    showAlertMessage("分配人數僅能輸入數字");
                    $($(this).find("input[id='Staffing']")[0]).select();
                    error = true;
                    return false;
                }

                nidx += 1;
            });

            if (error == false)
            {
                obj.Data = item;
                var jsonObj = { "obj": obj };
                $.ajax({
                    url: "PfaCycleRation/Edit",
                    type: "POST",
                    data: jsonObj,
                    async: true,
                    dataType: "json",
                    success: function (result) {
                        var message = result.message;
                        showAlertMsg(message, function () {
                            if (result.success) {
                                $('#PfaCycleRationDetailDialogDiv').modal('hide');
                                location.reload();
                            }
                        });
                    }
                });
            }
        });
    });
</script>